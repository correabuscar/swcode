#!/bin/bash

source "/swcode/swcode.bash"

rerunasroot "$@"

DNS_SERVERS_DNSMASQ_FILE="/etc/dnsmasq.d/servers.actual"
DNS_SERVERS=( $( grep -E '^\s*server\s*=\s*[0-9]+.[0-9]+.[0-9]+.[0-9]+\s*' -- "${DNS_SERVERS_DNSMASQ_FILE}" | sed -E 's/^\s*server\s*=\s*([0-9]+.[0-9]+.[0-9]+.[0-9]+)\s*/\1/' ) )
ALLOWED_FILE="/etc/dnsmasq.d/allowed_by_script.conf"
DENIED_FILE="/etc/dnsmasq.d/denied_by_script.conf"

base="$(basename -- "$0")"
if test "$base" == "dnswl"; then
  echo "Whitelisting mode" >&2
  APPEND_TO_FILE="$ALLOWED_FILE"
  what='allow'
elif test "$base" == "dnsbl"; then
  echo "Blacklisting mode" >&2
  APPEND_TO_FILE="$DENIED_FILE"
  what='deny'
else
  echo "!! Unknown basename '$base', aborting." >&2
  exit 4
fi

echo "Found ${#DNS_SERVERS[@]} DNS servers in file '${DNS_SERVERS_DNSMASQ_FILE}': '${DNS_SERVERS[*]}'" >&2

function add_to_dnsmasq_allow_list() {
  local host="$1"
  if test "$#" != "1"; then
    echo "!! You should pass only 1 arg to func '${FUNCNAME[0]}()', you passed $# args as '$*'" >&2
    exit 2
  fi

  echo "Host: '$host'" >&2
  for each_DNS_server in "${DNS_SERVERS[@]}"; do
    local expected
    if test "$what" == "allow"; then
      expected="server=/${host}/${each_DNS_server}"
    elif test "$what" == "deny"; then
      expected="address=/${host}/"
      #note that this works the same:
      #expected="server=/${host}/"
      #just don't add anything after the second "/", else it may even allow it, especially if it's 0.0.0.0
    else
      echo "Unhandled type '$what', aborting." >&2
    fi
    if ! grep -qF "$expected" -- "${APPEND_TO_FILE}" >/dev/null; then
      #it's not already allowed/denied, so add it!
      echo "$expected"
    fi
  done
}

if test "$#" == "0"; then
  echo "!! You should pass hostname(s) as arg(s)" >&2
  exit 3
fi

if ! test -f "${APPEND_TO_FILE}"; then
  echo "# Autogenerated by '$0' aka '$(realpath -- "$0")', DO NOT EDIT, just run \`'$0' hostname\`" > "${APPEND_TO_FILE}"
  echo "# for use by dnsmasq, this is file '${APPEND_TO_FILE}'" >> "${APPEND_TO_FILE}"
  echo "#" >> "$APPEND_TO_FILE"
  echo "# Beware that having a hostname here means dnsmasq will $what all its subdomains too!" >> "$APPEND_TO_FILE"
  echo "# Also having a hostname in both allow and in deny lists will make it be allowed(and its subdomains too, unless specific subdomains are only in deny list!)!" >> "$APPEND_TO_FILE"
  echo "#" >> "$APPEND_TO_FILE"
fi

#for tests:
#add_to_dnsmasq_allow_list blah "bla bla"
collected_whitelist_lines=(
$(for each in "$@"; do
  add_to_dnsmasq_allow_list "$each"
done
)
)
if test "${#collected_whitelist_lines[@]}" -gt 0; then
  #add all changes at once!
  #TODO: ensure it's locked so no two $0 can concurrently append here and make a racy mess!
  echo "${collected_whitelist_lines[@]}" | tr ' ' '\n' | tee -a "$APPEND_TO_FILE"
fi

echo "Done, file '$APPEND_TO_FILE' was updated! Now restarting dnsmasq to effectivate changes:"
rc-service dnsmasq restart
#note: reload won't do! needs to be 'restart'

